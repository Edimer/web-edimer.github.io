---
title: "Simulaci贸n matem谩tica con R: Ecuaci贸n Log铆stica"
author: "Edimer (Sidereus)"
date: "11-15-2022"
description: "En este documento se ejemplifican simulaciones con *R* para la ecuaci贸n diferencial log铆stica. ゐ锔"
categories:
  - R
  - Simulaci贸n
  - Matem谩ticas
image: "img1.png"
lang: es
css: estilo.css
format: 
  html:
    toc: true
    toc-title: "Tabla de contenido"
    smooth-scroll: true
    code-fold: true
    df-print: paged
    toc-location: left
    number-depth: 4
    code-copy: true
    highlight-style: github
    code-tools: 
      source: true 
    code-link: true 
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      fig.align = "center")

# Learn more about creating blogs with Distill at:
# https://rstudio.github.io/distill/blog.html

# Cargando funci贸n
```

# Motivaci贸n

<center>
<iframe width="600" height="450" src="https://www.youtube.com/embed/EOvLhZPevm0" frameborder="0" allowfullscreen></iframe>
</center>

# Configuraci贸n

```{r}
# =========== Configuraci贸n

# Bibliotecas
library(tidyverse)     # Manipulaci贸n de datos
library(hrbrthemes)    # Temas de ggplot2
library(plotly)        # Gr谩ficos interactivos
library(latex2exp)     # Latex en gr谩ficos

# Configuranto tema
theme_set(theme_modern_rc())
```

# Ecuaci贸n diferencial log铆stica

# Expresi贸n matem谩tica

$$\frac{\partial x}{\partial t} = \alpha x_t \times (1 - x_t)$$

## Parametrizaci贸n en R

### Funci贸n 1

- Se construyen dos funciones para realizar las simulaciones: `growth()` e `iterGrowth()` 
- Se definen los siguientes par谩metros para la funci贸n **`growth()`**:
  - `rate` ($\alpha$): tasa de crecimento o raz贸n de cambio. Relaci贸n de la natalidad con la mortalidad.
  - `xt`: tama帽o de la poblaci贸n inicial (%). $0 \leq x_t \leq 1$
  - **Retorno:** esta funci贸n devuelve el c谩lculo de la poblaci贸n mediante la ecuaci贸n anterior.
- Se definen los siguientes par谩metros para la funci贸n **`iterGrowth()`**:
  - `rate` ($\alpha$): tasa de crecimento o raz贸n de cambio. Relaci贸n de la natalidad con la mortalidad
  - `xt`: tama帽o de la poblaci贸n inicial (%). $0 \leq x_t \leq 1$
  - `t`:  n煤mero de generaciones (tiempo generacional) para evaluar el crecimiento poblacional.
  - `xinit`: es la misma `xt`, es decir, la poblaci贸n inicial. Aunque se repite es 煤til para registrar el tama帽o inicial de la poblaci贸n, ya que `xt` cambia al realizar la iteraci贸n recursiva con `while()`.
  - **Retorno:** esta funci贸n devuelve el c谩lculo de la poblaci贸n hasta el tiempo `t`, haciendo uso de la funci贸n `growth()` y sus par谩metros espec铆ficos.


```{r}
# =========== Funci贸n para simulaci贸n con ecuaci贸n log铆stica

# Crecimiento = (rate * xt) * (1 - xt)
growth <- function(rate, xt) {
  pob = (rate * xt) * (1 - xt)
  return(pob)
}

# Funci贸n recursiva para obtener la poblaci贸n para cada tiempo "t"
iterGrowth <- function(xt, rate, t, xinit) {
  res = NULL
  if (t == 0) {
    res = xt
    return(res)
  } else if (t == 1) {
    res = growth(rate = rate, xt = xt)
    return(res)
  } else{
    i = 1
    while (i <= (t)) {
      res[i + 1] = growth(rate = rate, xt = xt)
      xt = growth(rate = rate, xt = xt)
      i = i + 1
    }
    res[1] = xinit
    return(res)
  }
}
```

### Funci贸n 2

- Esta funci贸n facilita el proceso de conformar un `tibble` con los resultados de la simulaci贸n.

```{r}
dfGrowth <- function(xt, rate, t, xinit) {
  res = iterGrowth(xt,
                   rate,
                   t,
                   xinit) %>%
    enframe() %>%
    mutate(t = name - 1) %>%
    select(t, pob = value) %>%
    mutate(rate = as.factor(rate))
  return(res)
}
```


# Simulaciones

## Simulaci贸n 1

- 驴Qu茅 pasa en 100 generaciones con una poblaci贸n cuya natalidad es 1.72 veces mayor que la mortalidad y su poblaci贸n actual es 62% del m谩ximo te贸rico? 驴En qu茅 valor se estabiliza el crecimiento de la poblaci贸n? 驴Se extingue la poblaci贸n?
  - `rate`: 1.72
  - `xt`: 0.62
  - `t`: 100
  - `xinit`: 0.62
  
```{r}
r <- 1.72
xt <- 0.62
t <- 100
xinit <- xt

iterGrowth(rate = r, xt = xt, t = t, xinit = xinit) %>% 
  enframe() %>% 
  mutate(t = name - 1) %>% 
  select(t, pob = value) %>% 
  ggplot(aes(x = t, y = pob)) +
  geom_line(color = "firebrick2") +
  labs(x = "Tasa",
       y = "Estabilidad poblacional",
       title = "Equilibrio poblacional",
       subtitle = TeX(r'($x_{t+1}= (\alpha x_t) \times (1-x_t)$)'))
```

## Simulaci贸n 2

- 驴Qu茅 pasa en 100 generaciones con una poblaci贸n cuya natalidad es 0.72 veces menor que la mortalidad y su poblaci贸n actual es 62% del m谩ximo te贸rico? 驴En qu茅 valor se estabiliza el crecimiento de la poblaci贸n? 驴Se extingue la poblaci贸n?
  - `rate`: 0.72
  - `xt`: 0.62
  - `t`: 100
  - `xinit`: 0.62
  
```{r}
r <- 0.72
xt <- 0.62
t <- 100
xinit <- xt

iterGrowth(rate = r, xt = xt, t = t, xinit = xinit) %>% 
  enframe() %>% 
  mutate(t = name - 1) %>% 
  select(t, pob = value) %>% 
  ggplot(aes(x = t, y = pob)) +
  geom_line(color = "firebrick2") +
  labs(x = "Tasa",
       y = "Equilibrio poblacional",
       title = "Estabilidad poblacional",
       subtitle = TeX(r'($x_{t+1}= (\alpha x_t) \times (1-x_t)$)'))
```


## Simulaci贸n 3

- 驴Qu茅 pasa en 100 generaciones con una poblaci贸n cuya natalidad es igual que la mortalidad y su poblaci贸n actual es 62% del m谩ximo te贸rico? 驴En qu茅 valor se estabiliza el crecimiento de la poblaci贸n? 驴Se extingue la poblaci贸n?
  - `rate`: 0.72
  - `xt`: 0.62
  - `t`: 100
  - `xinit`: 0.62
  
```{r}
r <- 1
xt <- 0.62
t <- 100
xinit <- xt

iterGrowth(rate = r, xt = xt, t = t, xinit = xinit) %>% 
  enframe() %>% 
  mutate(t = name - 1) %>% 
  select(t, pob = value) %>% 
  ggplot(aes(x = t, y = pob)) +
  geom_line(color = "firebrick2") +
  labs(x = "Tasa",
       y = "Equilibrio poblacional",
       title = "Estabilidad poblacional",
       subtitle = TeX(r'($x_{t+1}= (\alpha x_t) \times (1-x_t)$)'))
```

## 3 simulaciones en 1

- Podemos graficar las tres simulaciones anteriores en un s贸lo gr谩fico.

```{r}
# ============== Simulaci贸n 3 en 1

# Par谩metros espec铆fico
r_sim1 <- 1.72
r_sim2 <- 0.72
r_sim3 <- 1

# Par谩metros generales
xt <- 0.62
t <- 100
xinit <- xt

# Uniendo datos de simulaciones
sim_1 <-
  iterGrowth(
    rate = r_sim1,
    xt = xt,
    t = t,
    xinit = xinit
  ) %>%
  enframe() %>%
  mutate(t = name - 1) %>%
  select(t, pob = value) %>% 
  mutate(rate = r_sim1)

sim_2 <-
  iterGrowth(
    rate = r_sim2,
    xt = xt,
    t = t,
    xinit = xinit
  ) %>%
  enframe() %>%
  mutate(t = name - 1) %>%
  select(t, pob = value) %>% 
  mutate(rate = r_sim2)

sim_3 <-
  iterGrowth(
    rate = r_sim3,
    xt = xt,
    t = t,
    xinit = xinit
  ) %>%
  enframe() %>%
  mutate(t = name - 1) %>%
  select(t, pob = value) %>% 
  mutate(rate = r_sim3)

sim_total <-
  bind_rows(sim_1, sim_2, sim_3)

sim_total %>% 
  mutate(rate = as.factor(rate)) %>% 
  ggplot(aes(x = t, y = pob, color = rate)) +
  geom_line() +
  scale_color_manual(values = c("#76b49f", "#ef3840", "#edea6f")) +
  labs(x = "Tasa",
       y = "Equilibrio poblacional",
       title = "Estabilidad poblacional",
       subtitle = TeX(r'($x_{t+1}= (\alpha x_t) \times (1-x_t)$)')) 
```

## Simulaci贸n 4

- En esta simulaci贸n se implementan diferentes tasas de crecimiento para ver el resultado en el equilibrio poblacional (en 100 generaciones) con una poblaci贸n cuyo tama帽o actual es 62% del m谩ximo te贸rico.

```{r}
# Par谩metros
r <- seq(from = 0.1, to = 3.6, by = 0.1)
xt <- 0.62
t <- 100
xinit <- xt

# Gr谩fico
r %>%
  map_df(.x = .,
         .f = ~ dfGrowth(
           rate = .,
           xt = xt,
           t = t,
           xinit = xinit
         )) %>%
  ggplot(aes(x = t, y = pob, color = rate)) +
  geom_line(alpha = 0.2) +
  scale_color_viridis_d() +
  labs(x = "Tasa",
       y = "Equilibrio poblacional",
       title = "Estabilidad poblacional",
       subtitle = TeX(r'($x_{t+1}= (\alpha x_t) \times (1-x_t)$)'))
```

## Simulaci贸n 5

- En esta simulaci贸n tomo tasas de crecimiento entre 3.5 y 3.8 (justamente donde aparece el *caos*) para ver el resultado en el equilibrio poblacional (en 100 generaciones) con una poblaci贸n cuyo tama帽o actual es 62% del m谩ximo te贸rico. **Nota:** para facilitar la visualizaci贸n de los patrones  se presenta de forma interactiva con `plotly`. 

```{r}
# Par谩metros
r <- seq(from = 3.5, to = 3.8, length = 20)
xt <- 0.62
t <- 100
xinit <- xt

# Gr谩fico
ggplotly(
  r %>%
  map_df(.x = .,
         .f = ~ dfGrowth(
           rate = .,
           xt = xt,
           t = t,
           xinit = xinit
         )) %>%
  ggplot(aes(x = t, y = pob, color = rate)) +
  geom_line(alpha = 0.2) +
  scale_color_viridis_d() +
  labs(x = "Tasa",
       y = "Equilibrio poblacional",
       title = "Estabilidad poblacional",
       subtitle = TeX(r'($x_{t+1}= (\alpha x_t) \times (1-x_t)$)'))
)
```

# Diagrama de bifurcaci贸n

## Simulaci贸n completa

- `rate`: 10 mil valores desde 0.1 a 3.8
- `xt`: 0.62
- `t`: 2 mil
- `xinit`: 0.62
- **Notas:** 
  - Estoy asumiendo que la estabilidad poblacional se logra en la mitad del tiempo, que para este ejemplo corresponde a mil.
  - Como la simulaci贸n se demora m谩s de 20 mintuos decid铆 guardar el archivo con los resultados e importarlos para construir los diagramas de bifurcaci贸n.

```{r, eval=FALSE}
# Par谩metros
r <- seq(from = 0, to = 4, length = 1000)
xt <- 0.62
t <- 2000
xinit <- xt
estabPob <- t / 2

# Simulaci贸n
set.seed(2022)
g <- r %>%
  map2_df(
    .x = .,
    .y = t,
    .f = ~ dfGrowth(
      rate = .,
      xt = xt,
      t = sample.int(n = .y, size = 1),
      xinit = xinit
    ) %>% slice(sample.int(n = .y, size = 1))
  )

# Exportando resultados simulaci贸n
write_csv(x = g, "data_simulation_rates.csv")
```

## Opci贸n 1

```{r}
result_simulation <- read_csv("data/data_simulation_rates.csv")

result_simulation %>% 
  ggplot(aes(x = rate, y = pob)) +
  geom_point(size = 0.1, color = "white")
```

## Opci贸n 2

```{r, warning=FALSE, fig.width=9, fig.height=6}
#| column: page
result_simulation %>% 
  ggplot(aes(x = rate, y = pob, color = pob)) +
  geom_point(size = 0.4) + 
  labs(x = "Tasa",
       y = "Estabilidad poblacional",
       title = "Diagrama de bifurcaci贸n",
       subtitle = TeX(r'($x_{t+1}= (\alpha x_t) \times (1-x_t)$)'),
       caption = TeX(r'(Lnea roja: $ \alpha \sim 3.57$)')) +
  geom_vline(xintercept = 3.57, color = "red", size = 0.4) +
  scale_color_viridis_c() +
  theme_modern_rc() +
  theme(legend.position = "none")
```

